<script>
    document.addEventListener('DOMContentLoaded', () => {

        // NEW: Register the datalabels plugin with Chart.js
        Chart.register(ChartDataLabels);

        // --- MOCK PRICE PROVIDER ---
        const mockPriceProvider = {
            prices: {
                "KBANK": 128.50, "AOT": 62.25, "PTT": 34.75, "SCB": 108.00, "CPALL": 55.50,
                "DELTA": 85.25, "ADVANC": 211.00, "GULF": 44.75
            },
            fetchRealtimePrices(symbols) {
                const newPrices = {};
                symbols.forEach(symbol => {
                    if (this.prices[symbol]) {
                        const change = (Math.random() - 0.5) * 0.5;
                        this.prices[symbol] = Math.max(10.0, this.prices[symbol] + change);
                        newPrices[symbol] = parseFloat(this.prices[symbol].toFixed(2));
                    } else {
                        this.prices[symbol] = Math.random() * 200 + 20;
                        newPrices[symbol] = parseFloat(this.prices[symbol].toFixed(2));
                    }
                });
                return newPrices;
            },
            fetchHistoricalData(symbol) {
                const data = [];
                let lastClose = this.prices[symbol] || 100;
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    const open = parseFloat((lastClose * (1 + (Math.random() - 0.5) * 0.05)).toFixed(2));
                    const close = parseFloat((open * (1 + (Math.random() - 0.5) * 0.05)).toFixed(2));
                    
                    data.push({
                        date: date.toLocaleDateString('en-GB'),
                        open: open,
                        close: close,
                    });
                    lastClose = close;
                }
                return data;
            }
        };
        
        // --- CLASS DEFINITIONS ---
        class Stock {
            constructor(symbol, quantity, buyPrice) {
                this.date = new Date().toLocaleDateString('en-GB');
                this.symbol = symbol.toUpperCase();
                this.quantity = parseFloat(quantity);
                this.buyPrice = parseFloat(buyPrice);
                this.totalBuy = this.quantity * this.buyPrice;
                this.currentPrice = this.buyPrice;
                this.currentTotal = this.totalBuy;
                this.net = 0;
            }

            updatePrice(newPrice) {
                this.currentPrice = newPrice;
                this.calculateTotal();
            }

            calculateTotal() {
                this.currentTotal = this.currentPrice * this.quantity;
                this.net = this.currentTotal - this.totalBuy;
            }
        }

        class Portfolio {
            constructor(name) {
                this.name = name;
                this.listStock = [];
                this.totalValue = 0;
                this.totalPort = 0;
            }

            addStock(stock) {
                const existingStock = this.listStock.find(s => s.symbol === stock.symbol);
                if (existingStock) {
                    const newTotalQuantity = existingStock.quantity + stock.quantity;
                    const newTotalBuy = existingStock.totalBuy + stock.totalBuy;
                    existingStock.buyPrice = newTotalBuy / newTotalQuantity;
                    existingStock.quantity = newTotalQuantity;
                    existingStock.totalBuy = newTotalBuy;
                } else {
                    this.listStock.push(stock);
                }
                this.calculatePort();
            }
            
            deleteStock(symbol) {
                this.listStock = this.listStock.filter(stock => stock.symbol !== symbol);
                this.calculatePort();
            }

            updateAllPrices(allPrices) {
                this.listStock.forEach(stock => {
                    if (allPrices[stock.symbol]) {
                        stock.updatePrice(allPrices[stock.symbol]);
                    }
                });
                this.calculatePort();
            }

            calculatePort() {
                this.totalValue = this.listStock.reduce((sum, stock) => sum + stock.currentTotal, 0);
                this.totalPort = this.listStock.reduce((sum, stock) => sum + stock.net, 0);
            }
        }

        class AutoPortfolioManager {
            constructor(portfolio, priceProvider) {
                this.port = portfolio;
                this.priceProvider = priceProvider;
                this.chartInstance = null;
            }

            startRealtimeUpdates() {
                this.updatePortPrices();
                setInterval(() => this.updatePortPrices(), 3000);
            }

            updatePortPrices() {
                const symbols = this.port.listStock.map(s => s.symbol);
                if (symbols.length === 0) return;
                
                const newPrices = this.priceProvider.fetchRealtimePrices(symbols);
                this.port.updateAllPrices(newPrices);
                this.report();
            }

            addStockToPort(symbol, quantity) {
                const currentPrice = this.priceProvider.fetchRealtimePrices([symbol.toUpperCase()])[symbol.toUpperCase()];
                const newStock = new Stock(symbol, quantity, currentPrice);
                this.port.addStock(newStock);
                this.report();
                this.updateGraphTab();
            }
            
            removeStockFromPort(symbol) {
                this.port.deleteStock(symbol);
                this.report();
                this.updateGraphTab();
            }

            report() {
                const portfolioBody = document.getElementById('portfolio-body');
                portfolioBody.innerHTML = '';
                
                this.port.listStock.forEach(stock => {
                    const row = document.createElement('tr');
                    const netClass = stock.net > 0 ? 'profit' : stock.net < 0 ? 'loss' : 'neutral';
                    
                    row.innerHTML = `
                        <td>
                            <strong>${stock.symbol}</strong>
                            <span class="delete-btn" data-symbol="${stock.symbol}">&#10006;</span>
                        </td>
                        <td>${stock.date}</td>
                        <td>${stock.quantity.toLocaleString()}</td>
                        <td>${stock.buyPrice.toFixed(2)}</td>
                        <td>${stock.totalBuy.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${stock.currentPrice.toFixed(2)}</td>
                        <td>${stock.currentTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="${netClass}">${stock.net.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    portfolioBody.appendChild(row);
                });

                document.getElementById('total-value').textContent = this.port.totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const totalNetEl = document.getElementById('total-net');
                totalNetEl.textContent = this.port.totalPort.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                totalNetEl.className = this.port.totalPort > 0 ? 'profit' : this.port.totalPort < 0 ? 'loss' : 'neutral';
            }

            updateGraphTab() {
                const selector = document.getElementById('stock-selector');
                const currentSelection = selector.value;
                selector.innerHTML = '';
                
                if (this.port.listStock.length === 0) {
                    selector.innerHTML = '<option>ไม่มีหุ้นในพอร์ต</option>';
                    if(this.chartInstance) {
                        this.chartInstance.destroy();
                        this.chartInstance = null;
                    }
                    return;
                }

                this.port.listStock.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock.symbol;
                    option.textContent = stock.symbol;
                    selector.appendChild(option);
                });

                if (currentSelection && this.port.listStock.some(s => s.symbol === currentSelection)) {
                    selector.value = currentSelection;
                }

                this.generateGraph(selector.value);
            }

            generateGraph(symbol) {
                if (!symbol) return;

                const historicalData = this.priceProvider.fetchHistoricalData(symbol);
                const labels = historicalData.map(d => d.date);
                const closePrices = historicalData.map(d => d.close);
                const pointColors = historicalData.map(d => d.close >= d.open ? '#2ecc71' : '#e74c3c');

                const ctx = document.getElementById('stock-chart').getContext('2d');
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                }

                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `ราคาปิดของ ${symbol}`,
                            data: closePrices,
                            borderColor: '#0984e3',
                            backgroundColor: 'rgba(9, 132, 227, 0.1)',
                            borderWidth: 2.5,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            fill: true,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: { color: '#3c6382' },
                                grid: { color: 'rgba(0,0,0,0.05)'}
                            },
                            x: {
                                ticks: { color: '#3c6382' },
                                grid: { color: 'rgba(0,0,0,0.05)'}
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#0a3d62' }
                            },
                            tooltip: {
                                enabled: true
                            },
                            datalabels: {
                                align: 'top',
                                anchor: 'end',
                                offset: 8,
                                backgroundColor: (context) => {
                                    const data = historicalData[context.dataIndex];
                                    return data.close >= data.open ? 'rgba(46, 204, 113, 0.8)' : 'rgba(231, 76, 60, 0.8)';
                                },
                                borderRadius: 4,
                                color: 'white',
                                font: {
                                    size: 9,
                                    weight: 'bold'
                                },
                                padding: 4,
                                formatter: (value, context) => {
                                    const data = historicalData[context.dataIndex];
                                    return `เปิด: ${data.open.toFixed(2)}\nปิด: ${data.close.toFixed(2)}`;
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- GLOBAL VARIABLES & UI REFERENCES ---
        let manager;
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleLink = document.getElementById('toggle-link');
        const toggleLink2 = document.getElementById('toggle-link-2');

        // --- AUTHENTICATION LOGIC ---
        const switchForm = (showLogin) => {
            loginForm.style.display = showLogin ? 'flex' : 'none';
            registerForm.style.display = showLogin ? 'none' : 'flex';
        };
        
        toggleLink.addEventListener('click', (e) => { e.preventDefault(); switchForm(false); });
        toggleLink2.addEventListener('click', (e) => { e.preventDefault(); switchForm(true); });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const users = JSON.parse(localStorage.getItem('stock_users')) || {};
            if(users[username]){
                alert('ชื่อผู้ใช้นี้มีอยู่แล้ว');
            } else {
                users[username] = { password: password, portfolio: { name: username, listStock: [] } };
                localStorage.setItem('stock_users', JSON.stringify(users));
                alert('สมัครสมาชิกสำเร็จ! กรุณาล็อกอิน');
                switchForm(true);
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const users = JSON.parse(localStorage.getItem('stock_users')) || {};
            if (users[username] && users[username].password === password) {
                sessionStorage.setItem('currentUser', username);
                initializeApp(username);
            } else {
                alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser && manager) {
                const users = JSON.parse(localStorage.getItem('stock_users')) || {};
                if(users[currentUser]){
                    users[currentUser].portfolio = {
                        name: manager.port.name,
                        listStock: manager.port.listStock.map(stock => ({...stock}))
                    };
                    localStorage.setItem('stock_users', JSON.stringify(users));
                }
            }
            sessionStorage.removeItem('currentUser');
            location.reload();
        });

        // --- INITIALIZATION ---
        function initializeApp(username) {
            authContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            const users = JSON.parse(localStorage.getItem('stock_users'));
            const userData = users[username];
            const myPortfolio = new Portfolio(username);
            if (userData.portfolio && userData.portfolio.listStock) {
                myPortfolio.listStock = userData.portfolio.listStock.map(plainStock => {
                    const stock = new Stock(plainStock.symbol, plainStock.quantity, plainStock.buyPrice);
                    stock.date = plainStock.date;
                    return stock;
                });
            }
            manager = new AutoPortfolioManager(myPortfolio, mockPriceProvider);
            manager.startRealtimeUpdates();
            manager.updateGraphTab();
        }

        const currentUser = sessionStorage.getItem('currentUser');
        if (currentUser) {
            initializeApp(currentUser);
        }

        // --- APP EVENT LISTENERS ---
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-content > div').forEach(tab => {
                    tab.style.display = 'none';
                });
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).style.display = 'block';
                if (tabId === 'graph-tab') {
                    manager.updateGraphTab();
                }
            });
        });

        document.getElementById('add-stock-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const symbol = document.getElementById('stock-symbol-input').value;
            const quantity = document.getElementById('stock-quantity-input').value;
            if (symbol && quantity > 0) {
                manager.addStockToPort(symbol, quantity);
                document.getElementById('add-stock-form').reset();
            }
        });

        document.getElementById('stock-selector').addEventListener('change', (e) => {
            manager.generateGraph(e.target.value);
        });
        
        document.getElementById('portfolio-body').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const symbolToDelete = e.target.getAttribute('data-symbol');
                if (confirm(`คุณต้องการลบหุ้น ${symbolToDelete} ออกจากพอร์ตใช่หรือไม่?`)) {
                    manager.removeStockFromPort(symbolToDelete);
                }
            }
        });
    });
</script>
